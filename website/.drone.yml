---
kind: pipeline
type: docker
name: default

steps:
  - name: Build
    image: node:14-alpine
    commands:
      - cd website
      - apk add python3 make g++
      - npm install
      - npm run build
---
kind: pipeline
type: docker
name: promote

trigger:
  event:
    - promote
  target:
    - production

steps:
  - name: Generate
    image: node:14-alpine
    commands:
      - cd website
      - apk add python3 make g++
      - npm install
      - npm run generate
  - name: Zip
    image: alpine:latest
    commands:
      - cd website
      - apk add zip
      - mkdir website
      - cd dist
      - zip -r ../website/dist.zip *
  - name: Upload to S3
    image: amazon/aws-cli
    environment:
      AWS_ACCESS_KEY_ID: 
        from_secret: s3Access
      AWS_SECRET_ACCESS_KEY:
        from_secret: s3Secret
      AWS_DEFAULT_REGION: eu-west-2
      AMP_WEBSITE_APP_ID:
        from_secret: ampId
    commands:
      - cd website
      - aws s3api put-object --bucket bradley-chatha --key website/dist.zip --body website/dist.zip
  - name: Trigger deployment
    image: alpine:latest
    environment:
      PROSTAGMA_SECRET:
        from_secret: prostagma
    commands:
      - apt fetch curl
      - "curl -X POST -H 'Authorization: Bearer $PROSTAGMA_SECRET' https://prostagma.chatha.dev/webhook/personal"